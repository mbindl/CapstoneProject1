<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Mapping Nitrates and Cancer</title>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #sidebar {
        z-index: 99;
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        width: 400px;
      }

      #text {
        color: white;
        padding: 3%;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.14/"></script>

    <script>
      require([
        "esri/config",
        "esri/WebMap",
        "esri/Map",
        "esri/views/MapView",
        "esri/tasks/Geoprocessor",
        "esri/layers/TileLayer",
        "esri/layers/FeatureLayer",
        "esri/widgets/Expand",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapToggle",
        "esri/widgets/LayerList",
        "esri/widgets/LayerList/LayerListViewModel",
        "esri/widgets/Home",
        "esri/widgets/Legend",
        "esri/widgets/Print",
        "esri/renderers/ClassBreaksRenderer",
        "dojo/dom"
      ], function(
        esriConfig,
        WebMap,
        Map,
        MapView,
        Geoprocessor,
        TileLayer,
        FeatureLayer,
        Expand,
        BasemapGallery,
        BasemapToggle,
        LayerList,
        LayerListVM,
        Home,
        Legend,
        Print,
        ClassBreaksRenderer,
        dom
      ) {

          {
        esriConfig.portalUrl = "https://trpa.maps.arcgis.com";
            };
        
        var webmap = new WebMap({
              portalItem: { // autocasts as new PortalItem()
                id: "1946a89da2e442488ef6ce969be0ecce"
              }
            });

        var view = new MapView({
              map: webmap,  // The WebMap instance created above
              container: "viewDiv",
              center: [-89.7,44.8],
              zoom: 7,
              padding: {
                right: 400 // Same value as the #sidebar width in CSS
          }
            });
          
//        document
//          .getElementById("submit")
//          .addEventListener("click", runAnalysis);
//
//        function runAnalysis() {
//              var message = document.getElementById("message");
//        // initialize geoprocessor task
//            var gpUrl =
//              "https://maps.trpa.org/server/rest/services/CancerRatesNitrateValues/GPServer/Cancer%20Rates%20and%20Nitrate%20Values";
//    
//            var gp = new Geoprocessor({
//              url: gpUrl,
//              outSpatialReference: {
//                wkid: 102100
//              }
//            });
//              
//            var gpParams = {
//                k: dom.byId("kvalue").value,
//                HexSize: dom.byID("hexsize")
//                }
//              
//            gp.submitJob(gpParams).then(drawResultData);
//          }
//
//        function drawResultData(result) {
//            clearAll()
//            webmap.add(layerCancer);
//            webmap.add(layerNitrates);
//            webmap.add(layerResiduals);
//            webmap.add(layerStdDev);
//            });

          
        const defaultSym = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [128, 128, 128, 0.2],
            width: "0.5px"
          }
        };


        const rendererCancer = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: defaultSym,
          label: "Hex Bin",
          visualVariables: [
            {
              type: "color",
              field: "CancerRate",
//              normalizationField: "",
              legendOptions: {
                title: "Cancer Rate"
              },
              stops: [
                {
                  value: 500,
                  color: "#FFFFD4",
                  label: "< 500"
                },
                {
                  value: 750,
                  color: "#FED98E",
                },
                {
                  value: 1000,
                  color: "#FE9929",
                  label: "< 1000"
                },
                {
                  value: 1250,
                  color: "#D95F0E",
                },
                {
                  value: 1500,
                  color: "#993404",
                  label: "< 1500"
                }
              ]
            }
          ]
        };
          
        const rendererNitrate = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: defaultSym,
          label: "Hex Bin",
          visualVariables: [
            {
              type: "color",
              field: "NitrateRate",
//              normalizationField: "",
              legendOptions: {
                title: "Nitrate Rate"
              },
              stops: [
                {
                  value: 2,
                  color: "#F2F0F7",
                  label: "2"
                },
                {
                  value: 4,
                  color: "#CBC9E2",
                  label: "4"
                },
                {
                  value: 6,
                  color: "#9E9AC8",
                  label: "6"
                },
                {
                  value: 10,
                  color: "#756BB1",
                  label: "10"
                },
                {
                  value: 15,
                  color: "#54278F",
                  label: "15"
                }
              ]
            }
          ]
        };
          
        const rendererResidual = {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: defaultSym,
          label: "Hex Bin",
          visualVariables: [
            {
              type: "color",
              field: "Residual",
//              normalizationField: "",
              legendOptions: {
                title: "Residual"
              },
              stops: [
                {
                  value: -400,
                  color: "#000004",
                  label: "-400"
                },
                {
                  value: -100,
                  color: "#51127C",
                  label: "-100"
                },
                {
                  value: 100,
                  color: "#B7377A",
                  label: "100"
                },
                {
                  value: 400,
                  color: "#FC8861",
                 label: "400"
                },
                {
                  value: 810,
                  color: "#FC8861",
                  label: "800"
                }
              ]
            }
          ]
        };
          
        const rendererStdDev= {
          type: "simple", // autocasts as new SimpleRenderer()
          symbol: defaultSym,
          label: "Hex Bin",
          visualVariables: [
            {
              type: "color",
              field: "StdResidual",
//              normalizationField: "",
              legendOptions: {
                title: "Standard Deviation"
              },
              stops: [
                {
                  value: -1,
                  color: "#000004",
                  label: "-1"
                },
                {
                  value: -0.25,
                  color: "#51127C",
                  label: "-0.25"
                },
                {
                  value: 0.25,
                  color: "#B7377A",
                  label: " 0.25"
                },
                {
                  value: 1,
                  color: "#FC8861",
                 label: " 1"
                },
                {
                  value: 2.5,
                  color: "#FC8861",
                  label: " 2.5"
                }
              ]
            }
          ]
        };
          
        var layerCancer = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_HexBin/MapServer/0",
          title : "Cancer Rate (People Per 10k)",
          renderer: rendererCancer
        }); 
                
        var layerNitrate = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_HexBin/MapServer/0",
          title : "Nitrate Rate",
          renderer: rendererNitrate
        }); 
//        
        var layerResidual = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_HexBin/MapServer/0",
          title : "Residual",
          renderer: rendererResidual
        }); 
          
        var layerStdDev = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_HexBin/MapServer/0",
          title : "Standard Deviation",
          renderer: rendererStdDev
        })
          
        var layerWell = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_Project1_BaseData/MapServer/0",
          title : "Well"
        }); 
        
        var layerTract = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_Project1_BaseData/MapServer/1",
          title : "Census Tract"
        });
          
        var layerCounty = new FeatureLayer({
          url: "https://maps.trpa.org/server/rest/services/Geography777_Project1_BaseData/MapServer/2",
          title : "County"
        });  
          
        webmap.add(layerCancer);
        webmap.add(layerNitrate);
        webmap.add(layerResidual);
        webmap.add(layerStdDev);
          
        // Add a legend instance to the panel of a
        // ListItem in a LayerList instance
        const layerList = new LayerList({
              view: view,
              listItemCreatedFunction: function(event) {
                const item = event.item;
                if (item.layer.type != "group") {
                  // don't show legend twice
                  item.panel = {
                    content: "legend",
                    open: false
                  };
                }
              }
        });

        view.ui.add(layerList, "top-right");

      // Create collapasable button for Table of Contents
        var layerListExpand = new Expand({
            expandIconClass: "esri-icon-layers",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
            expandTooltip: "Layer List",
            view: view,
            autoCollapse: true,
            content: layerList.domNode
            });

        // add layer list button to the top right corner of the view
        view.ui.add(layerListExpand, "top-right");

        // function to create print service
        view.when(function() {
            var print = new Print({
                container: document.createElement("div"),
                view: view,
                // specify print service url
                printServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
        });

        // Create Print Button
        var printExpand = new Expand({
            expandIconClass: "esri-icon-printer",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font/
            expandTooltip: "Print",
            view: view,
            autoCollapse: true,
            content: print.domNode
            });

        // Add print widget to the top right corner of the view
        view.ui.add(printExpand, "top-right");
        });
          
        // move zoom buttons to top left
        view.ui.move("zoom", "top-left");
                
        // Createa Home Button
        var homeWidget = new Home({
            view: view
        });

        // adds the home widget to the top left corner of the MapView
        view.ui.add(homeWidget, "top-left");            

        var basemapToggle = new BasemapToggle({
            container: document.createElement("div"),
            view: view,
            nextBasemap: "hybrid"  // Allows for toggling to the "hybrid" basemap
        });

        // Create an Expand instance and set the content
        // property to the DOM node of the basemap gallery widget
        var bgExpand = new Expand({
            expandIconClass: "esri-icon-basemap",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font
            expandTooltip: "Toggle Basemap",
            view: view,
            content: basemapToggle.domNode
        });

        // Add the basemap gallery button
        view.ui.add(bgExpand, "bottom-left"); 

        // add a legend widget instance to the view
        // and set the style to 'card'. This is a
        // responsive style, which is good for mobile devices
        // or 'classic' for PC users
        const legend = new Expand({
            expandIconClass: "esri-icon-layer-list",  // see https://developers.arcgis.com/javascript/latest/guide/esri-icon-font
            expandTooltip: "Legend",
            content: new Legend({
                view: view,
                style: "classic" // other styles include 'card'
                }),
            view: view,
            expanded: true
        });
          
        view.ui.add(legend, "bottom-right");
    
      });
    </script>
  
</head>
  <body>
    <div id="viewDiv">
      <div id="sidebar" class="esri-widget">
        <div id="text">
        <h2>Cancer Rates and Nitrate Levels</h2>
            <h3>An exploratory analysis.</h3>
          <p>
              High nitrate concentrations in drinking water are a health hazard. Recently a possible cancer risk in adults from nitrate (and nitrite) has emerged, but the magnitude of the risk is unknown. The Wisconsin Department of Natural Resources has collected data on cancers by cataloging the location of all cancer occurrences over a ten-year period. In addition, they assembled a database of nitrate levels in a group of test wells throughout the state.
            </p>
            <p>              
              This application allows the user to investigate the relationship between nitrate levels and cancer through spatial analysis. The first part of the application performs an inverse distance weighting (IDW) analysis to produce an interpolated raster surface representing nitrate levels. The IDW process uses a weighted distance coeficient <i>k</i>. There is no theory to say what the distance exponent <i>k</i> should be. 
            </p>
            <p>    
                Please choose a value for <i>k</i> that is greater than 1 and a <i>Hex Bin</i> size (sq. mi.) to aggregate the analysis results:  
            </p>
            <form>
              <input type="text" id="kvalue" name="kvalue" value="2">
              <input type="submit" value="Run Analysis">
            </form>             
            <p> After the IDW raster of Nitrate values is created the application will autmatically aggregate the mean values of both nitrates and cancer rates to 500 square mile hexbins and run an ordinary least squares (OLS) regression to determine if nitrate concentrations are related to cancer occurrences.
            </p>
            <p>   
            The results of the OLS regression are mapped here as a color ramp of the Residual values and available by clicking on a hexbin to view the attributes in a popup.
            </p>
        </div>
      </div>
    </div>
  </body>
</html>
